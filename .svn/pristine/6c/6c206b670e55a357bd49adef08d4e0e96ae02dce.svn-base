using System;
using System.Collections.Generic;
using System.Text;

namespace Maticsoft.BLL.serviceimpl
{
    public class ReservedFieldsImpl
    {
        /// <summary>
        /// 向保留字段列表插入一条数据
        /// </summary>
        /// <param name="currentOrder"></param>
        /// <returns></returns>
        public int addReservedFields(string key, string value, Maticsoft.Common.ReservedFieldsHelper.ReservedFieldsType type, string description)
        {
            string sql = String.Format("INSERT INTO reserved_fields VALUES('{0}','{1}','{2}','{3}')", key, value, Maticsoft.Common.ReservedFieldsHelper.getReservedFieldsType(type), description);

            try
            {
                return Maticsoft.Common.dbUtility.SQLiteHelper.getBLLInstance().ExecuteNonQuery(sql);
            }
            catch (Exception e)
            {
                if (createReservedFields(e))
                {
                    return Maticsoft.Common.dbUtility.SQLiteHelper.getBLLInstance().ExecuteNonQuery(sql);
                }
                else
                {
                    throw;
                }
            }
        }

        /// <summary>
        /// 修改向保留字段
        /// </summary>
        /// <param name="key"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        public int updateReservedFields(string key, string value)
        {
            string sql = String.Format("UPDATE reserved_fields SET key = '{0}',value = '{1}' WHERE KEY = '{0}'", key, value);

            try
            {
                return Maticsoft.Common.dbUtility.SQLiteHelper.getBLLInstance().ExecuteNonQuery(sql);
            }
            catch (Exception e)
            {
                if (!createReservedFields(e))
                {
                    throw;
                }
                else
                {
                    return -1;
                }
            }
        }

        /// <summary>
        /// 获取保留字段列表，如果表不存在，则建立新表。
        /// </summary>
        /// <returns></returns>
        public Maticsoft.Common.model.reserved_fields getReservedFields(string columnName)
        {
            try
            {
                List<Maticsoft.Common.model.reserved_fields> list = new List<Maticsoft.Common.model.reserved_fields>();
                string sql = string.Format("SELECT * FROM reserved_fields WHERE key = '{0}'", columnName);
                System.Data.DataSet ds = Maticsoft.Common.dbUtility.SQLiteHelper.getBLLInstance().Query(sql);
                if (ds.Tables[0].Rows.Count > 0)
                {
                    list = (List<Maticsoft.Common.model.reserved_fields>)Maticsoft.Common.CollectionHelper.ConvertTo<Maticsoft.Common.model.reserved_fields>(ds);
                }
                return list[0];
            }
            catch (Exception e)
            {
                if (e.Message.Contains("索引超出范围"))
                {
                    this.addReservedFields(columnName,"0",Maticsoft.Common.ReservedFieldsHelper.ReservedFieldsType.TrueOrFalse,"");

                    List<Maticsoft.Common.model.reserved_fields> list = new List<Maticsoft.Common.model.reserved_fields>();
                    string sql = string.Format("SELECT * FROM reserved_fields WHERE key = '{0}'", columnName);
                    System.Data.DataSet ds = Maticsoft.Common.dbUtility.SQLiteHelper.getBLLInstance().Query(sql);
                    if (ds.Tables[0].Rows.Count > 0)
                    {
                        list = (List<Maticsoft.Common.model.reserved_fields>)Maticsoft.Common.CollectionHelper.ConvertTo<Maticsoft.Common.model.reserved_fields>(ds);
                    }
                    return list[0];
                }
                if (createReservedFields(e))
                {
                    return null;
                }
                else
                {
                    throw;
                }
            }
        }

        /// <summary>
        /// 创建保留字段表
        /// </summary>
        /// <param name="e"></param>
        /// <returns></returns>
        private bool createReservedFields(Exception e)
        {
            if (e.Message.Contains("no such table"))
            {
                string sql = @" CREATE TABLE 'main'.'reserved_fields' ('key'  TEXT NOT NULL,'value'  TEXT,'type'  TEXT NOT NULL,'description'  TEXT,PRIMARY KEY ('key'));";
                Maticsoft.Common.dbUtility.SQLiteHelper.getBLLInstance().Query(sql);
                return true;
            }
            else
            {
                return false;
            }
        }
    }
}
