using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Data;
using System.Text;
using System.Windows.Forms;
using Maticsoft.Common;
using Maticsoft.Common.model;
using System.IO.Ports;
using Maticsoft.Common.Util;
using Maticsoft.BLL.log;

namespace Demo
{
    public partial class UnitConfigCMDTest : UserControl,IDisposable
    {
        private SerialPort sp = new SerialPort();//串口

        public UnitConfigCMDTest()
        {
            InitializeComponent();
        }

        //~UnitConfigCMDTest()
        //{
        //    this.sp.Close();
        //}

        private void UnitConfigCMDTest_Load(object sender, EventArgs e)
        {
            //初始化串口下拉框
            foreach (store_machine sm in Global.storeMachineList)
            {
                ComboboxItem item = new ComboboxItem(sm, sm.com_name);
                this.cBoxCOM.Items.Add(item);
            }

            if (this.cBoxCOM.Items.Count > 0)
            {
                this.cBoxCOM.SelectedIndex = 0;
            }
            

            this.itemKeyA.LbKeyText.Click += itemKey_Click;
            this.itemKeyRight.LbKeyText.Click += itemKey_Click;
            this.itemKeyDown.LbKeyText.Click += itemKey_Click;
            this.itemKeyLeft.LbKeyText.Click += itemKey_Click;
            this.itemKeyPageDown.LbKeyText.Click += itemKey_Click;
            this.itemKeyDotUp.LbKeyText.Click += itemKey_Click;
            this.itemKeyEquality.LbKeyText.Click += itemKey_Click;
            this.itemKeyComma.LbKeyText.Click += itemKey_Click;
            this.itemKeySingleQuoteLeft.LbKeyText.Click += itemKey_Click;
            this.itemKeySemicolon.LbKeyText.Click += itemKey_Click;
            this.itemKeySign.LbKeyText.Click += itemKey_Click;
            this.itemKeyDel.LbKeyText.Click += itemKey_Click;
            this.itemKeyTab.LbKeyText.Click += itemKey_Click;
            this.itemKeyEnd.LbKeyText.Click += itemKey_Click;
            this.itemKeyUp.LbKeyText.Click += itemKey_Click;
            this.itemKeyZero.LbKeyText.Click += itemKey_Click;
            this.itemKeyPageUp.LbKeyText.Click += itemKey_Click;
            this.itemKeyCapsLock.LbKeyText.Click += itemKey_Click;
            this.itemKeyBackslash.LbKeyText.Click += itemKey_Click;
            this.itemKeySlash.LbKeyText.Click += itemKey_Click;
            this.itemKeySquareBracketsRight.LbKeyText.Click += itemKey_Click;
            this.itemKeySquareBracketsLeft.LbKeyText.Click += itemKey_Click;
            this.itemKeyIns.LbKeyText.Click += itemKey_Click;
            this.itemKeyEsc.LbKeyText.Click += itemKey_Click;
            this.itemKeyThree.LbKeyText.Click += itemKey_Click;
            this.itemKeyTwo.LbKeyText.Click += itemKey_Click;
            this.itemKeyOne.LbKeyText.Click += itemKey_Click;
            this.itemKeyDot.LbKeyText.Click += itemKey_Click;
            this.itemKeyZ.LbKeyText.Click += itemKey_Click;
            this.itemKeyY.LbKeyText.Click += itemKey_Click;
            this.itemKeyX.LbKeyText.Click += itemKey_Click;
            this.itemKeyW.LbKeyText.Click += itemKey_Click;
            this.itemKeyV.LbKeyText.Click += itemKey_Click;
            this.itemKeyU.LbKeyText.Click += itemKey_Click;
            this.itemKeyT.LbKeyText.Click += itemKey_Click;
            this.itemKeyS.LbKeyText.Click += itemKey_Click;
            this.itemKeySix.LbKeyText.Click += itemKey_Click;
            this.itemKeyFive.LbKeyText.Click += itemKey_Click;
            this.itemKeyFour.LbKeyText.Click += itemKey_Click;
            this.itemKeyEnter.LbKeyText.Click += itemKey_Click;
            this.itemKeyR.LbKeyText.Click += itemKey_Click;
            this.itemKeyQ.LbKeyText.Click += itemKey_Click;
            this.itemKeyP.LbKeyText.Click += itemKey_Click;
            this.itemKeyO.LbKeyText.Click += itemKey_Click;
            this.itemKeyN.LbKeyText.Click += itemKey_Click;
            this.itemKeyM.LbKeyText.Click += itemKey_Click;
            this.itemKeyL.LbKeyText.Click += itemKey_Click;
            this.itemKeyK.LbKeyText.Click += itemKey_Click;
            this.itemKeyJ.LbKeyText.Click += itemKey_Click;
            this.itemKeyNine.LbKeyText.Click += itemKey_Click;
            this.itemKeyEight.LbKeyText.Click += itemKey_Click;
            this.itemKeySeven.LbKeyText.Click += itemKey_Click;
            this.itemKeyBackspace.LbKeyText.Click += itemKey_Click;
            this.itemKeyI.LbKeyText.Click += itemKey_Click;
            this.itemKeyH.LbKeyText.Click += itemKey_Click;
            this.itemKeyG.LbKeyText.Click += itemKey_Click;
            this.itemKeyF.LbKeyText.Click += itemKey_Click;
            this.itemKeyE.LbKeyText.Click += itemKey_Click;
            this.itemKeyD.LbKeyText.Click += itemKey_Click;
            this.itemKeyC.LbKeyText.Click += itemKey_Click;
            this.itemKeyB.LbKeyText.Click += itemKey_Click;
            this.itemKeyA.LbKeyText.Click += itemKey_Click;
            this.itemKeyMinus.LbKeyText.Click += itemKey_Click;
            this.itemKeyPlus.LbKeyText.Click += itemKey_Click;
            this.itemKey_F12.LbKeyText.Click += itemKey_Click;
            this.itemKey_F11.LbKeyText.Click += itemKey_Click;
            this.itemKey_F10.LbKeyText.Click += itemKey_Click;
            this.itemKey_F9.LbKeyText.Click += itemKey_Click;
            this.itemKey_F8.LbKeyText.Click += itemKey_Click;
            this.itemKey_F7.LbKeyText.Click += itemKey_Click;
            this.itemKey_F6.LbKeyText.Click += itemKey_Click;
            this.itemKey_F5.LbKeyText.Click += itemKey_Click;
            this.itemKey_F4.LbKeyText.Click += itemKey_Click;
            this.itemKey_F3.LbKeyText.Click += itemKey_Click;
            this.itemKey_F2.LbKeyText.Click += itemKey_Click;
            this.itemKey_F1.LbKeyText.Click += itemKey_Click;
        }


        private void itemKey_Click(object sender, EventArgs e)
        {
            if (!this.sp.IsOpen)
            {
                MsgBox.getInstance().Show(String.Format("未打开串口", ""), "错误", MsgBox.MyButtons.OK);
                return;
            }

            String keyText = ((ItemKey)((Label)sender).Parent).ValueStr;
            byte[] sendcmd = new byte[256];
            int cmd_length = 0, sendcmdlength = 0;

            //直接发送命令
            if (!this.panelCMD.Enabled)
            {
                byte[] dataCommand = null;
                //需要特殊转换的
                if (GlobalConstants.keyBoardKeyValue.ContainsKey(keyText))
                {
                    dataCommand = new byte[] { GlobalConstants.keyBoardKeyValue[keyText]};
                    cmd_length = 1;
                }
                else
                {
                    dataCommand = CommandProcessor.betDataToCommand(keyText, out cmd_length);
                }
                //组装命令                
                Array.Copy(dataCommand, 0, sendcmd, sendcmdlength, cmd_length);
                sendcmdlength += cmd_length;
                sendcmd = CommandProcessor.packCommand(sendcmd, GlobalConstants.cmdSign_KV[GlobalConstants.BASE_CMD.KEYBOARD], sendcmdlength);
                String cmd = CommandProcessor.bytesToHexString(sendcmd);
                bool b = SerialPortUtil.writeData(this.sp, sendcmd, sendcmdlength + 10);
                //记录信息
                LogUtil.getInstance().addLogDataToQueue("命令测试,发送命令:" + cmd.Substring(0, (sendcmdlength + 10) * 2) + (b ? "成功!" : "失败!"), GlobalConstants.LOGTYPE_ENUM.TICKET_LOG);
            }
            else
            {
                this.txtBoxSend.Text += keyText;
            }
        }


        /// <summary>
        /// 启用禁用命令编辑区
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void btnShowHide_Click(object sender, EventArgs e)
        {
            if (((Button)sender).Text == "启用")
            {
                if (!this.sp.IsOpen)
                {
                    MsgBox.getInstance().Show(String.Format("未打开串口", ""), "错误", MsgBox.MyButtons.OK);
                    return;
                }

                FrmPassEnter frm = new FrmPassEnter();
                DialogResult result = frm.ShowDialog();
                if (result == DialogResult.OK)
                {
                    ((Button)sender).Text = "禁用";
                }
                else if (result == DialogResult.No)
                {
                    MsgBox.getInstance().Show(String.Format("密码错误", ""), "错误", MsgBox.MyButtons.OK);
                    return;
                }
                else
                {
                    return;
                }
                
            }
            else
            {
                ((Button)sender).Text = "启用";
            }

            this.panelCMD.Enabled = !this.panelCMD.Enabled;
        }

        /// <summary>
        /// 打开串口
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void btnOpenCOM_Click(object sender, EventArgs e)
        {
            if (this.btnOpenCOM.Text.Contains("关闭"))
            {
                try
                {
                    this.sp.Close();
                    this.btnOpenCOM.Text = "打开串口";
                }
                catch (Exception)
                {
                    MsgBox.getInstance().Show(String.Format("关闭串口失败", this.sp.PortName), "错误", MsgBox.MyButtons.OK);
                }
            }
            else
            {
                store_machine sm = (store_machine)((ComboboxItem)this.cBoxCOM.SelectedItem).Key;
                if (!this.sp.IsOpen)
                {
                    try
                    {
                        //每次打开时重新赋值，有可能在设置中修改过对应的值了
                        this.sp.BaudRate = (int)sm.com_baudrate;
                        this.sp.PortName = sm.com_name;
                        this.sp.DataBits = (int)sm.com_databits;
                        this.sp.StopBits = GlobalConstants.StopBitsDic[sm.com_stopbits];
                        this.sp.Parity = GlobalConstants.ParityDic[sm.com_parity];

                        this.sp.Open();
                        this.btnOpenCOM.Text = "关闭串口";
                    }
                    catch (Exception)
                    {
                        //串口打开失败
                        MsgBox.getInstance().Show(String.Format("打开串口失败", sm.com_name), "错误", MsgBox.MyButtons.OK);
                    }
                }
                else
                {
                    //串口已经打开
                    MsgBox.getInstance().Show(String.Format("串口已经打开", sm.com_name), "错误", MsgBox.MyButtons.OK);
                }
            }
        }

        //关闭串口
        public void ClosePort()
        {
            this.sp.Close();
        }
    }
}
