using System;
using System.Collections.Generic;
using System.Data;
using System.IO.Ports;
using System.Text;
using System.Threading;
using Maticsoft.Common.model;
using Maticsoft.Common.Util;

namespace Maticsoft.Common.model
{
    public class SerialPortInfo
    {
        private SerialPort sp;//串口        

        //private Boolean isCanRead;//当前串口是否可读票(如果正在出票则值为false)
        //private Boolean isCanWrite;//当前串口是否可打印票(如果正在出票则值为false)
        //private Boolean isCanCheck;//是否可启动检查(出票，读取票面数据完成后此状态为true)

        private Boolean isGetCMD;//是否已获取命令
        private Boolean isSendCMD;//是否已发送命令

        /// <summary>
        /// 向串口发送数据时的毫秒数——如果处理完票后用的时间超过了动态时间，不需要再休眠动态时间
        /// </summary>
        private Int64 send_data_millis = -1;        

        private String orderId;//当前处理的订单号
        private lottery_ticket ticket;//要处理的彩票数据

        private GlobalConstants.PRINT_STATE_ENUM printState;//当前的打印状态

        private Boolean isError;//是否有错误
        private String errorCode;//错误代码 
        private String errorState;//错误状态，UNTREATED:未处理；PROCESSED:已处理;
        private String errorMsg;//错误信息描述


        private store_machine macInfo;//出票机器信息
        private GlobalConstants.SerialPortInfoState this_state;//当前调度器资源的状态   

        private int interruptState;//中断状态

        private Boolean isCanStop;//就算发出了停止的指令，也必须等到所有的动作完成后才能处理停止


        #region 调度器初始化
        /// <summary>
        /// 构造方法
        /// </summary>
        /// <param name="sp">串口</param>
        /// <param name="isAvailable">串口目前是否可用(未打开或是被占用均为“N)</param>
        /// <param name="canNextStep">是否可进行下一步</param>
        /// <param name="macInfo">出票机器信息</param>
        /// <param name="ticket">要处理的彩票数据</param>
        public SerialPortInfo(SerialPort sp, store_machine macInfo)
        {
            this.sp = sp;
            this.IsError = false;
            this.MacInfo = macInfo;
            this.OrderId = String.Empty;

            this.IsGetCMD = false;
            this.IsSendCMD = true;

            this.InterruptState = 0;
            this.IsCanStop = true;            

            this.THIS_STATE = GlobalConstants.SerialPortInfoState.INITIAL_STATE;
        }

        #endregion 调度器初始化

        #region 刷新调度器的初始状态
        public void refresh()
        {
            try
            {
                this.IsError = false;
                //this.OrderId = String.Empty; 不能清空-因为现在的取票线程是按照这个id去取票的
                this.Ticket = null;
                this.IsCanStop = true;

                this.InterruptState = 0;
                this.CompeletTicketIdStateQueue.Clear();
                this.THIS_STATE = GlobalConstants.SerialPortInfoState.INITIAL_STATE;

                //关闭串口
                if (this.Sp.IsOpen)
                {
                    try
                    {
                        this.Sp.Close();
                    }
                    catch (Exception)
                    {
                        this.IsError = true;
                        this.ErrorCode = "100002";
                        this.ErrorState = "UNTREATED";
                        this.ErrorMsg = String.Format("关闭串口{0}失败!", this.Sp.PortName);
                        //this.IsCanCheck = true;
                        this.PRINT_STATE = GlobalConstants.PRINT_STATE_ENUM.WAIT_CHECK;
                    }
                }
            }
            catch (Exception e)
            {               
                throw e;
            }            
        }
        #endregion 刷新调度器的初始状态

        public GlobalConstants.PRINT_STATE_ENUM PRINT_STATE
        {
            get { return printState; }
            set { printState = value; }
        }
        public GlobalConstants.SerialPortInfoState THIS_STATE
        {
            get { return this_state; }
            set { this_state = value; }
        }
        public String OrderId
        {
            get { return orderId; }
            set
            {
                orderId = value;
            }
        }
        public SerialPort Sp
        {
            get { return sp; }
            set
            {
                sp = value;
            }
        }
        public Boolean IsError
        {
            get { return isError; }
            set
            {
                isError = value;
            }
        }
        public String ErrorMsg
        {
            get { return errorMsg; }
            set
            {
                errorMsg = value;
            }
        }
        public store_machine MacInfo
        {
            get { return macInfo; }
            set
            {
                macInfo = value;
            }
        }
        public lottery_ticket Ticket
        {
            get { return ticket; }
            set
            {
                ticket = value;
            }
        }
        //public Boolean IsCanRead
        //{
        //    get { return isCanRead; }
        //    set
        //    {
        //        isCanRead = value;
        //    }
        //}
        //public Boolean IsCanWrite
        //{
        //    get { return isCanWrite; }
        //    set
        //    {
        //        isCanWrite = value;
        //    }
        //}
        //public Boolean IsCanCheck
        //{
        //    get { return isCanCheck; }
        //    set
        //    {
        //        isCanCheck = value;
        //    }
        //}

        public Boolean IsGetCMD
        {
            get { return isGetCMD; }
            set
            {
                isGetCMD = value;
            }
        }

        public String ErrorCode
        {
            get { return errorCode; }
            set
            {
                errorCode = value;
            }
        }
        public String ErrorState
        {
            get { return errorState; }
            set
            {
                errorState = value;
            }
        }

        public Int64 Send_data_millis
        {
            get { return send_data_millis; }
            set { send_data_millis = value; }
        }

        /// <summary>
        /// 打印完成的票队列
        /// </summary>
        public Queue<KeyValuePair<String, String>> CompeletTicketIdStateQueue = new Queue<KeyValuePair<String, String>>();

        public Boolean IsSendCMD
        {
            get { return isSendCMD; }
            set
            {
                isSendCMD = value;
            }
        }
        public int InterruptState
        {
            get { return interruptState; }
            set
            {
                interruptState = value;
            }
        }

        public Boolean IsCanStop
        {
            get { return isCanStop; }
            set { isCanStop = value; }
        }
    }
}
